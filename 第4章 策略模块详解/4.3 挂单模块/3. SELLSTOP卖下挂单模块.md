# 3. `SELLSTOP`卖下挂单模块

- `SELLSTOP`: 是指以**低于现价的价格挂单**卖出的操作指令.`SELLSTOP`是一个杀跌的行为

假设现在`EUR:USD = 1: 1.4321`,你认为只有EUR向下突破了`1.4300`,才能确定跌势,并进一步下跌.
则可以在`EUR:USD = 1: 1.4290`处挂一张`SELLSTOP`挂单,当`EUR:USD < 1: 1.4290`时,挂单才会成交,如果继续下跌,那么你会盈利(挂一个卖单,
该卖单的成交价比当前的市价低,卖出后再以更低的价格买入,这个操作结束后你就盈利了).

```mq4
//+------------------------------------------------------------------+
//|                                                   SELLSTOP挂单.mq4 |
//|                                  Copyright 2025, MetaQuotes Ltd. |
//|                                             https://www.mql5.com |
//+------------------------------------------------------------------+
#property copyright "Copyright 2025, MetaQuotes Ltd."
#property link      "https://www.mql5.com"
#property version   "1.00"
#property strict

// orderVolume 下单量
double orderVolume;

// currencyPair 货币对
string currencyPair;

// maxOrderVolume 最大下单量
double maxOrderVolume = 100;

// stopProfitPoint 止盈点数
// stopProfitPrice 止盈价格
double stopProfitPoint, stopProfitPrice;

// stopLossPoint 止损点数
// stopLossPrice 止损价格
double stopLossPoint, stopLossPrice;

// MAGIC 魔术号,和EA是1对1关系.本质是一个用户自定义的订单标识.用于在同一个账户中,标识不同EA下的订单
int MAGIC = 104;

// ticket 表示订单的唯一标识符(ID)
int ticket;

// slippage 滑点 即: 下单时预期的成交价格 与 最终实际成交价格 之间的差值
// 滑点是有正负的 
// 正滑点表示实际成交价格比我预期的好(例如我期望1.1000价格买入,但实际成交价格为1.0008,即产生了2个正滑点)
// 负滑点表示实际成交价格比我预期的差(例如我期望1.1000价格买入,但实际成交价格为1.1015,即产生了15个负滑点)
int slippage;

// alertFlag 标识是否开启警告的标记位
bool alertFlag = false;

// pendingOrderLineNumber 线条数量
// 线条: 当设置了1个BUYSTOP挂单时,系统会在设定的挂单价格位置画一条水平线.这条线就是挂单的触发价位.
// 所以这里说的"线条",实际上就是挂单位置.市场价格(K线)一旦触碰或超过这条线,挂单就会被执行,变成一张真实订单.
int pendingOrderLineNumber;

// 点数距离: 即相邻两个BUYLIMIT挂单之间的点数距离
int pointDistance;

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
//--- create timer
   EventSetTimer(10);
   
//---
   return(INIT_SUCCEEDED);
  }
//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
  {
//--- destroy timer
   EventKillTimer();
   
  }
//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
  {
//---
   
  }
//+------------------------------------------------------------------+
//| Timer function                                                   |
//+------------------------------------------------------------------+
void OnTimer()
  {
//---
   orderVolume = 0.01;
   currencyPair = Symbol();
   pointDistance = 200;
   pendingOrderLineNumber = 3;
   stopLossPoint = 100;
   stopProfitPoint = 300;
   
   placeSellSELLSTOPOrder();
  }
//+------------------------------------------------------------------+
// 本函数用于根据全局变量pendingOrderLineNumber的值
// 挂一组SELLSTOP单
// SELLSTOP单: 以低于现价(BID价格)的价格卖出的订单.SELLSTOP单的成交价格都是低于挂单时的市场价格的
// 按照定义上来讲 多个连续的SELLSTOP单 只要定义的成交价是递减的(第N个SELLSTOP单成交价 = 第N-1个BUYSTOP单成交价 - 点数距离)即可
// TODO: 这里书中用的是ASK价格 但是我认为卖单应该用BID价格
void placeSellSELLSTOPOrder() {
   // 将下单量的数值转换为指定精度
   orderVolume = NormalizeDouble(orderVolume, 2);
   
   // 限制下单量的数值必须大于系统默认该货币对的最小下单量
   if (orderVolume < MarketInfo(currencyPair, MODE_MINLOT)) {
      orderVolume = MarketInfo(currencyPair, MODE_MINLOT);
   }
   
   // 限制下单量的数值不得大于预设的最大下单量
   if (orderVolume > maxOrderVolume) {
      orderVolume = maxOrderVolume;
   }
   
   // 限制下单量的数值必须小于系统默认该货币对的最大下单量
   if (orderVolume > MarketInfo(currencyPair, MODE_MAXLOT)) {
      orderVolume = MarketInfo(currencyPair, MODE_MAXLOT);
   }
   
   // 限制挂单之间的点数距离
   if (pointDistance <= 2) {
      return;
   }
   
   // 限制要挂的订单数量
   if (pendingOrderLineNumber <= 0) {
      return;
   }
   
   for(int pendingOrderLineIndex = 1; pendingOrderLineIndex <= pendingOrderLineNumber; pendingOrderLineIndex++) {
       // 第N个SELLSTOP卖单的卖出价格为 市价 - N * 点数距离
      double placePrice = MarketInfo(currencyPair, MODE_BID) - pendingOrderLineIndex * pointDistance * MarketInfo(currencyPair, MODE_POINT);
      
      // 第N个SELLSTOP卖单的止盈价 = 第N个SELLSTOP卖单的卖出价格 - 止盈点数
      stopProfitPrice = placePrice - stopProfitPoint * MarketInfo(currencyPair, MODE_POINT);
      
      // 第N个SELLSTOP卖单的止损价 = 第N个SELLSTOP卖单的卖出价格 + 止损点数
      stopLossPrice = placePrice + stopLossPoint * MarketInfo(currencyPair, MODE_POINT);
      
      /*
      Print("这是SELLSTOP的第 ", pendingOrderLineIndex, " 单");
      Print("BID价格为: ", MarketInfo(currencyPair, MODE_BID));
      Print("下单价格为: ", placePrice);
      Print("订单止盈价: ", stopProfitPrice);
      Print("订单止损价: ", stopLossPrice);
      */
      
      ticket = OrderSend(currencyPair, OP_BUYLIMIT, orderVolume, placePrice, slippage, stopLossPrice, stopProfitPrice, "BUYSTOP", MAGIC, 0, Green);
      
      if (!alertFlag) {
         continue;
      }
      
      if (ticket < 0) {
         Alert("BUYLIMIT下买单失败: ", GetLastError());
         continue;
      }
      
      Alert("BUYLIMIT下买单成功");
   }
}
```

| `SELLSTOP`订单顺序 | 市价(`BID`价格) |  下单价格   |  订单止盈价  |  订单止损价  |
|:--------------:|:-----------:|:-------:|:-------:|:-------:|
|       1        |   173.953   | 173.753 | 173.453 | 173.853 |
|       2        |   173.953   | 173.553 | 173.253 | 173.653 |
|       3        |   173.953   | 173.353 | 173.053 | 173.453 |
