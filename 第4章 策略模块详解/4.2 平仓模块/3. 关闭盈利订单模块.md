# 3. 关闭盈利订单模块

```mq4
//+------------------------------------------------------------------+
//|                                                       平盈利单模块.mq4 |
//|                                  Copyright 2025, MetaQuotes Ltd. |
//|                                             https://www.mql5.com |
//+------------------------------------------------------------------+
#property copyright "Copyright 2025, MetaQuotes Ltd."
#property link      "https://www.mql5.com"
#property version   "1.00"
#property strict

// 货币对
string currencyPair = Symbol();

// 魔术号
int MAGIC = 101;

// 滑点
int slippage = 0;

// 标识是否开启警告的标记位
bool alertFlag = false;

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
//--- create timer
   EventSetTimer(60);
   
//---
   return(INIT_SUCCEEDED);
  }
//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
  {
//--- destroy timer
   EventKillTimer();
   
  }
//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
  {
//---
   
  }
//+------------------------------------------------------------------+
//| Timer function                                                   |
//+------------------------------------------------------------------+
void OnTimer()
  {
//---
   
  }
//+------------------------------------------------------------------+
// 本函数用于关闭盈利的订单
void closeProfitableOrder() {
   // 关闭订单时的买价
   double buyPrice;
   
   // 关闭订单时的卖价
   double sellPrice;
   
   // 订单号
   int ticket;
   
   // 订单手数
   double lots;
   
   // 订单类型
   int type;
   
   // 标识订单是否关闭成功的标量
   bool closeResult = false;
   
   for(int orderIndex = OrdersTotal() - 1; orderIndex >= 0; orderIndex--) {
      bool selectResult = OrderSelect(orderIndex, SELECT_BY_POS);
      if (!selectResult) {
         break;
      }
      
      // 选择符合要求(该EA创建的/指定货币对的)且盈利的订单
      if (OrderSymbol() != currencyPair) {
         continue;
      }
      
      if (OrderMagicNumber() != MAGIC) {
         continue;
      }
      
      // 计算订单净利润
      // OrderSwap(): 隔夜费.是2种货币的利率的差值,有正负.仅在持有仓位过夜的场景下返回值不为0,且返回值有正负.正值表示我赚取了利率差,负值表示我需要支付利率差.
      // OrderCommission(): 佣金.若返回值为0,表示交易商以点差(ASK - BID)作为佣金.否则返回的是交易商收取的额外佣金(浮动的或者是固定的),通常该函数的返回值为0或负值.
      // 因为这2个函数返回的值都已经带有正负了(正值表示我赚了;负值表示我亏了),因此计算净利润时全都使用`+`.
      double retainedProfits = OrderProfit() + OrderSwap() + OrderCommission();
      
      if (retainedProfits <= 0) {
         continue;
      }
      
      // 获取关闭订单时用到的变量
      buyPrice = MarketInfo(currencyPair, MODE_ASK);
      sellPrice = MarketInfo(currencyPair, MODE_BID);
      ticket = OrderTicket();
      lots = OrderLots();
      type = OrderType();
      
      // 关闭盈利的买单
      if (type == OP_BUY) {
         closeResult = OrderClose(ticket, lots, sellPrice, slippage, Yellow);
      }
      
      // 关闭盈利的买单
      if (type == OP_SELL) {
         closeResult = OrderClose(ticket, lots, buyPrice, slippage, Red);
      }
      
      if (alertFlag && closeResult) {
         Alert("关闭订单成功,关闭的订单类型为: ", type);
         continue;
      }
      
      if (alertFlag && !closeResult) {
         Alert("关闭订单失败: ", GetLastError());
         continue;
      }
   }
}
```

- `OrderSwap()`: 掉期值,又称隔夜利息/隔夜利率,指的是当你把一个仓位持有过夜(即交易日结束后仍未平仓)时,交易商根据你所交易的利率差,向你收取或支付的一笔费用.放在交易软件里叫库存费或隔夜费.

假设现在`EUR:JPY = 1:100`.我看多欧元,所以借了100日元,去买1欧元.然后我持有这1欧元过夜了.

再假设: 欧元利率4%,日元利率1%.那么我转天早晨起来,交易商需要支付我0.04欧元的利息,我需要向交易商支付1日元的利息.

假设我们结算利息时,`EUR:JPY = 1: 150`.那么我们结算利息时,我收入了`0.04欧元 * 150 = 6日元`的利息,支出了1日元的利息,净赚5日元.

注: 复习内容:

在我借了100日元,去买1欧元之后,欧元涨了,比例为`EUR:JPY = 1:120`.那么我卖掉手里的1欧元,换得120日元.还债100日元,还剩20日元是我的利润.
	
- `OrderCommission()`: 佣金.放在交易软件叫手续费.
  - 若返回值为0,则表示交易商通过点差(`ASK - BID`)的方式收取佣金
  - 若返回值不是0,则显示的金额是交易商额外收取的固定/浮动佣金

- 注意事项

`OrderSwap()`和`OrderCommission()`的返回值都是自带符号的.也就是说:

- 如果隔夜费是我赚了,则`OrderSwap()`返回正值,表示我赚了利息差
- 如果隔夜费是我亏了,则`OrderSwap()`返回负值,表示我要支付利息差
- 但`OrderCommission()`一般为0或负值,表示我要向经纪商支付佣金

所以: `净利润 = OrderProfit() + OrderCommission() + OrderSwap()`
